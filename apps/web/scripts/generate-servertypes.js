#!/usr/bin/env node

import { readdirSync, existsSync, mkdirSync, writeFileSync } from "fs";
import { join, dirname } from "path";

const bindingsDir = join(import.meta.dirname, "../../backend/bindings");
const outputFile = join(import.meta.dirname, "../lib/servertypes.ts");

/**
 * Recursively find all .ts files in a directory
 */
function findTypeScriptFiles(dir, relativePath = "") {
	const files = [];

	try {
		const entries = readdirSync(dir, { withFileTypes: true });

		for (const entry of entries) {
			const fullPath = join(dir, entry.name);
			const relPath = join(relativePath, entry.name);

			if (entry.isDirectory()) {
				files.push(...findTypeScriptFiles(fullPath, relPath));
			} else if (entry.isFile() && entry.name.endsWith(".ts")) {
				// Remove .ts extension for import path
				files.push(relPath.replace(/\.ts$/, ""));
			}
		}
	} catch (err) {
		console.error(`Error reading directory ${dir}:`, err);
	}

	return files;
}

/**
 * Generate the export statements
 */
function generateExports(files) {
	// Sort files alphabetically
	const sortedFiles = files.sort();

	// Group files by directory for better organization in output
	const grouped = {};

	for (const file of sortedFiles) {
		const dir = dirname(file) || "root";
		if (!grouped[dir]) {
			grouped[dir] = [];
		}
		grouped[dir].push(file);
	}

	let output =
		"// File automatically generated by generate-servertypes.js. Don't edit manually!\n";

	// Generate exports, grouping by directory
	const dirs = Object.keys(grouped).sort((a, b) => {
		if (a === "root") return -1;
		if (b === "root") return 1;
		return a.localeCompare(b);
	});

	for (const dir of dirs) {
		const files = grouped[dir];

		for (const file of files) {
			output += `export * from "../../backend/bindings/${file}";\n`;
		}

		// Add blank line between groups (but not after the last group)
		if (dir !== dirs[dirs.length - 1]) {
			output += "\n";
		}
	}

	return output;
}

function main() {
	console.log(`Scanning bindings directory: ${bindingsDir}`);

	const files = findTypeScriptFiles(bindingsDir);

	if (files.length === 0) {
		console.warn("No TypeScript files found in bindings directory");
		return;
	}

	console.log(`Found ${files.length} TypeScript binding(s)`);

	const exports = generateExports(files);

	const outputDir = dirname(outputFile);
	if (!existsSync(outputDir)) {
		mkdirSync(outputDir, { recursive: true });
	}

	writeFileSync(outputFile, exports);
	console.log(`Updated ${outputFile}`);
}

main();
